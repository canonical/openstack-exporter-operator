name: Pull Request

on:
  pull_request:
    branches:
      - main

jobs:

  code-quality:
    name: Run code quality checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python3 -m pip install tox
      - name: Run linters
        run: tox -e lint

  unit-test:
    name: Run unit test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python3 -m pip install tox
      - name: Run unit test
        run: tox -e unit

  check-file-updates:
    name: Check updates for grafana dashboard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout local repository
        uses: actions/checkout@v4
      - name: Check differences
        run: make check-dashboard-updates

  integration-test:
    needs: [code-quality, unit-test]
    uses: canonical/bootstack-actions/.github/workflows/func.yaml@v3
    strategy:
      fail-fast: false
    with:
      command: "tox -e integration"
      juju-channel: "3.1/stable"
      nested-containers: false
      timeout-minutes: 120
      action-operator: false
      external-controller: true
      runs-on: "['self-hosted', 'runner-openstack-exporter']"
      juju-controller: soleng-ci-ctrl
      zaza-yaml: "LS0tCm1vZGVsX3NldHRpbmdzOgogIGltYWdlLXN0cmVhbTogcmVsZWFzZWQKcmVnaW9uOiBwcm9kc3RhY2s2CmNsb3VkOiBidWlsZGVyLWNsb3VkCmNyZWRlbnRpYWw6IGJ1aWxkZXItY2xvdWQtY3JlZAo="
    secrets:
      juju-controllers-yaml: ${{ secrets.JUJU_CONTROLLERS_YAML }}
      juju-accounts-yaml: ${{ secrets.JUJU_ACCOUNTS_YAML }}
      openstack-auth-env: ${{ secrets.OPENSTACK_AUTH_ENV }}
